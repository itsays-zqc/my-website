# Analysis

<font face = "Calibri">

<div class="text-justify">

Analysis is an extension function for three basic solvers. In this section, we will introduce the coding method of analysis corresponding to FDE, FDTD and EME.
Type of the analysis. Selections are ['FDEAnalysis', 'EMEAnalysis', 'Overlap', 'far_field', 'mode_expansion']


## 7.1 FDE Analysis

```python
add_analysis(
        name: str,
        type: Literal["fde_analysis"],
        property: dict,
    )
```
### 7.1.1 Simulation name
The name of the simulation solver, and only one solver is allowed to be added to the project.
### 7.1.2 Workflow id
The name of the result folder generated by the simulation solver，which can be obtained when the simulation solver is completed. The script for obtaining the workflow id is shown below, assuming that the simulation solver has already been set up.

```python
simu_res = simu[simu_name].run()
workflow_id_name = simu_res.workflow_id
```

### 7.1.2 Modal Analysis
| Parameter                                          | Type    | Default           | Description                                                                  |
|:---------------------------------------------------|:--------|:------------------|:-----------------------------------------------------------------------------|
|  calculate_modes                     | boolean | False             |The eigenmode supported by the structure will be solved.     |
|  mesh_structure                      | boolean | False             |Generate an images of mesh structure , which is very useful for checking material settings.            |
|  wavelength                          | number  | 1.55              |The wavelength used to solve the modes. |
|  wavelength_offset                   | number  | 0                 | The wavelength offset used to solve the modes. |
|  number_of_trial_modes               | integer | 10                | The maximum number of modes stored in the mode list.                |
|  search                              | string  | max_index         | Select 'max_index' or 'near_n' to define the effective refractive index for mode calculation.      |
|  calculate_group_index               | boolean | False             |                                                                              |


bent_waveguide:

| Parameter                                          | Type    | Default           | Description                                                                  |
|:---------------------------------------------------|:--------|:------------------|:-----------------------------------------------------------------------------|
|bent_waveguide       | boolean | False             |                                                                              |
|radius               | number  | 0                 | A float, or a parameter, or a parameter expression that evaluates to a float |
|orientation          | number  | 0                 | A float, or a parameter, or a parameter expression that evaluates to a float |
|location             | string  | simulation_center | Selections are ['simulation_center']                                         |
|n                                   | number  | 1                 | A float, or a parameter, or a parameter expression that evaluates to a float |

### 7.1.3 Frequency Analysis
| Parameter                                          | Type    | Default           | Description                                                                  |
|:---------------------------------------------------|:--------|:------------------|:-----------------------------------------------------------------------------|
|  frequency_analysis              | boolean | False             |                                                                              |
|  start_wavelength                | number  | 1.55              | A float, or a parameter, or a parameter expression that evaluates to a float |
|  stop_wavelength                 | number  | 1.499             | A float, or a parameter, or a parameter expression that evaluates to a float |
|  number_of_points                | integer | 10                |                                                                              |
|  effective_index                 | number  | 1                 | A float, or a parameter, or a parameter expression that evaluates to a float |
|  detailed_dispersion_calculation | boolean | False             |                                                                              |

**Example:**

```python
simu_name = "FDE"
analysis_name = "FDE_Analysis"
analysis = pj.Analysis()
analysis.add_analysis(name=analysis_name, type="FDEAnalysis",
                        props={"workflow_id": simu_res.workflow_id, "simulation_name": simu_name,
                                "modal_analysis": {"calculate_modes": True, "mesh_structure": True,
                                                "wavelength": 1.55, "wavelength_offset": 0.0001, "number_of_trial_modes": 20,
                                                "search": "max_index", 
                                                "calculate_group_index": False,
                                                "bent_waveguide": {"bent_waveguide": False, "radius": 1, "orientation": 0, "location": "simulation_center", }
                                                },
                                "frequency_analysis": {"frequency_analysis": False,
                                                    "start_wavelength": 1.50, "stop_wavelength": 1.60, "number_of_points": 3,
                                                    "effective_index": 1, "detailed_dispersion_calculation": False,
                                                    }})
result_fde = analysis["DC_FDE_Analysis"].run()                                                   
```


## 7.2 EMEAnalysis

### 7.1.1  Simulation name
The name of the simulation solver, and only one solver is allowed to be added to the project.
### 7.1.2 Workflow id
The name of the result folder generated by the simulation solver，which can be obtained when the simulation solver is completed. The script for obtaining the workflow id is shown below, assuming that the simulation solver has already been set up.

```python
simu_res = simu[simu_name].run()
workflow_id_name = simu_res.workflow_id
```
                                        
### 7.2.2 Eme propagate
eme_propagate 
override_group_spans
cell_group_settings
span
sc: Selections are ['none', 'sub_cell']                                        

### 7.2.3 Periodicity
periodicity
periodic_group_definition.

| Parameter                                          | Type    | Default           | Description                                                                  |
|:---------------------------------------------------|:--------|:------------------|:-----------------------------------------------------------------------------|
|  periodicity                                  | boolean | False        |                                                                              |
|  start_cell_group | string  |              | 'group_span_1' represents the first group, and so on                         |
|  end_cell_group   | string  |              | 'group_span_1' represents the first group, and so on                         |
|  periods          | integer |              |                                                                              |

### 7.2.4 Group span sweep
| Parameter                                          | Type    | Default           | Description                                                                  |
|:---------------------------------------------------|:--------|:------------------|:-----------------------------------------------------------------------------|
|  group_span_sweep                        | boolean | False        |                                                                              |
|  parameter                               | string  | group_span_1 | 'group_span_1' represents the first group, and so on                         |
|  start                                   | number  | 0            | A float, or a parameter, or a parameter expression that evaluates to a float |
|  stop                                    | number  | 1            | A float, or a parameter, or a parameter expression that evaluates to a float |
|  number_of_points                        | integer | 3            |                                                                              |

### 7.2.5 Wavelength sweep
|Parameter                                 | Type    | Default        | Description                                                                               |
|:---------------------------------------|:--------|:---------------|:------------------------------------------------------------------------------------------|
| wavelength_sweep                        | boolean | False        |                                                                              |
| start                                   | number  | 1.5          | A float, or a parameter, or a parameter expression that evaluates to a float |
| stop                                    | number  | 1.6          | A float, or a parameter, or a parameter expression that evaluates to a float |
| number_of_wavelength_points             | integer | 3            |                                                                              |

### 7.2.6 Select source
|Parameter                                 | Type    | Default        | Description                                                                               |
|:---------------------------------------|:--------|:---------------|:------------------------------------------------------------------------------------------|
| phase                                      | number  | 0            | A float, or a parameter, or a parameter expression that evaluates to a float |
| source_port                                | object  |              | Select an EME port object                                                    |
| select_mode                                | string  | TE           | Selections are ['TE', 'TM']                                                  |
| wavelength                           | number  |              | This parameter takes effect when 'use_wavelength_sweep' of EME solver is true|

**Example:**

```python
analysis = pj.Analysis()
analysis.add(name="eme_propagate", type="eme_analysis",
                property={"workflow_id": eme_base_res.workflow_id, "eme_propagate": True,
                        "periodicity": {"periodicity": True,
                                        "periodic_group_definition": [{"start_cell_group": "group_span_1",
                                                                        "end_cell_group": "group_span_1",
                                                                        "periods": grating_periods}]},
                        "group_span_sweep": {"group_span_sweep": False,
                                        "parameter": "group_span_1", "start": 41, "stop": 61, "number_of_points": 11},
                        "wavelength_sweep": {"wavelength_sweep": False,
                                        "start": 1.5, "stop":1.6, "number_of_wavelength_points": 11},
                        "select_source": {"phase": 0, "select_mode": "TE"}})
eme_res = analysis["eme_propagate"].run()
```


## 7.3  ModeExpansion

### 7.3.1   Simulation name
The name of the simulation solver, and only one solver is allowed to be added to the project.
### 7.3.2 Workflow id
The name of the result folder generated by the simulation solver，which can be obtained when the simulation solver is completed. The script for obtaining the workflow id is shown below, assuming that the simulation solver has already been set up.

```python
simu_res = simu[simu_name].run()
workflow_id_name = simu_res.workflow_id
```
### 7.3.3 Mode expansion
direction: Selections are 'positive', 'negative'.                         
monitors_for_expansion: The name of the power monitor needs to analyze mode expansion.
mode_calculation

|Parameter                                 | Type    | Default        | Description                                                                               |
|:---------------------------------------|:--------|:---------------|:------------------------------------------------------------------------------------------|
| mode_selection                                          | string  | -                  | Selections are ['fundamental', 'fundamental_TE', 'fundamental_TM', 'user_select']|
| mode_expansion.mode_calculation.mode_index                                              | array   | -                  | 1d list, the index of the mode to be expanded, for example, [0, 1, 2]            |
| mode_calculation.search                                                  | string  | max_index         | Selections are ['max_index', 'near_n']                                           |
| mode_calculation.n                                                       | number  | 1.0               | A float, or a parameter, or a parameter expression that evaluates to a float     |
| number_of_trial_modes                                   | integer | 20                |                                                                                  |
| override_global_options                                 | boolean | False             |                                                                                  |
|sample_spacing          | integer | 0                 |                                                                                  |
| use_wavelength_spacing  | boolean | True              |                                                                                  |
|  use_source_limits       | boolean | False             |                                                                                  |
|override_global_monitor_setting| boolean | False             |                                                                                  |
|sspacing_type            | string  | wavelength        | Selections are ['wavelength', 'frequency']                                       |
|spacing_limit           | string  | min_max           | Selections are ['min_max', 'center_span']                                        |
|wavelength_min          | number  |-                   | A float, or a parameter, or a parameter expression that evaluates to a float     |
| override_global_monitor_setting.frequency_points        | integer | 5                 |                                                                                  |
| bent_waveguide.use_bent_waveguide                       | boolean | False             |                                                                                  |
| bent_waveguide.radius                                   | number  | 1.0               | A float, or a parameter, or a parameter expression that evaluates to a float     |
| bent_waveguide.orientation                              | number  | 0.0               | A float, or a parameter, or a parameter expression that evaluates to a float     |
| bent_waveguide.location                                 | string  | simulation_center | Selections are ['simulation_center']                                             |
| override_default_boundary_conditions                                     | boolean | False             |                                                                                  |
rotate_settings.theta                                                                   | number  | 0                 | A float, or a parameter, or a parameter expression that evaluates to a float     |
| rotate_settings.phi                                                                     | number  | 0                 | A float, or a parameter, or a parameter expression that evaluates to a float     |
| rotate_settings.rotation_offset                                                         | number  | 0                 | A float, or a parameter, or a parameter expression that evaluates to a float     |
| modal_analysis.mode_removal.threshold                                                   | number  | 0.01              | A float, or a parameter, or a parameter expression that evaluates to a float     |

**Example:**

```python  
fdtd_res = simu[simu_name].run(
            # resources={"compute_resources": "gpu", "gpu_devices": [{"id": 0}]}
        )

analysis = pj.Analysis()
analysis.add(name="me_through", type="ModeExpansion",
                property={"workflow_id": fdtd_res.workflow_id,
                        "mode_expansion": {"direction": "positive",
                                           "monitors_for_expansion": [{"frequency_monitor": "through"}],
                                           "mode_calculation": {"mode_selection": "user_select", "mode_index": [0, 1, 2, 3],
                                                                "override_global_monitor_setting": {"wavelength_center": wavelength, "wavelength_span": 0.1, "frequency_points": 11}}}})
me_res = analysis["me_through"].run()
```



## 7.4 Farfield

|Parameter                                 | Type    | Default        | Description                                                                               |
|:---------------------------------------|:--------|:---------------|:------------------------------------------------------------------------------------------|
| huygens_source                         | string  | -               | Selections are ['from_dataspace', 'from_monitor']                                         |
| workflow_id                            | string  |-                | The name of the result folder generated by the FDE solver                                 |
| field_data.fde_analysis_name           | string  |-                | The name of the FDE analysis needs to analyze far field      | only need to input one of  |
| field_data.mode                        | integer | 0              |                                                                                           |
| field_data.data                        | object  | -               | Select a dataspace object                                                                 |
| power_monitor_name                     | string  |-                | The name of the power monitor needs to analyze far field     | the two parameters         |


### Frequency_settings
|Parameter                                 | Type    | Default        | Description                                                                               |
|:---------------------------------------|:--------|:---------------|:------------------------------------------------------------------------------------------|
| auto                | boolean | False          |                                                                                           |
| wavelength          | number  |  -              |                                                                                           |
| frequency           | number  |-                |                                                                                           |
| projection_method   | string  |-                | Selections are ['planar', 'angular']                                                      |
| material index      | number  |-                | A float, or a parameter, or a parameter expression that evaluates to a float              |
| farfield filter     | number  |-                | A float, or a parameter, or a parameter expression that evaluates to a float              |
| projection distance | number  | -               | A float, or a parameter, or a parameter expression that evaluates to a float              |
| points in x         | integer | -               |                                                                                           |
| points_in_y         | integer |-                |                                                                                           |
| farfield x span     | number  | -               | A float, or a parameter, or a parameter expression that evaluates to a float              |
| farfield y span     | number  |-                | A float, or a parameter, or a parameter expression that evaluates to a float              |
| farfield x          | number  | -               | A float, or a parameter, or a parameter expression that evaluates to a float              |
| farfield y          | number  |-                | A float, or a parameter, or a parameter expression that evaluates to a float              |
| projection direction| string  |-                | Selections are ['forward', 'backward']                                                    |
| horizontal points   | integer |-                |                                                                                           |
| vertical points     | integer |-                |                                                                                           |


**Example:**

```python
if run_options.run_far_field:
    fde_res =  = analysis["FDEAnalysis"].run()
        far_field_base_workflow_id = fde_res.workflow_id

    if run_options.run_far_field:
        analysis.add(name="Far_Field", type="FarField",
                     property={
                         'huygens_source': 'from_dataspace',  # selections are ['from_dataspace','from_monitor']
                         'workflow_id': far_field_base_workflow_id,
                         'field_data': {"fde_analysis_name": "FDEAnalysis",
                                        'mode': 0,
                                         },
                         'far_field_settings': {'projection_method': 'planar',  # selections are ['planar','angular']
                                                'material_index': 3.7,
                                                'farfield_filter': 0,
                                                'projection_distance': 8000,
                                                'points_in_x': 50,
                                                'points_in_y': 50,
                                                'farfield_x_span': 40,
                                                'farfield_y_span': 40,
                                                'farfield_x': 0,
                                                'farfield_y': 0,}}
                     )
        far_field_res = analysis["Far_Field Simulation"].run()

```
## 7.4 Overlap


| Parameter                 | Type    | Default   | Description                                                      |
|:--------------------------|:--------|:----------|:-----------------------------------------------------------------|
| field_1workflow_id       | string  |-           | The name of the result folder generated by the FDE solver        |
| field_1.mode              | integer |-           |                                                                  |
| field_1.data              | object  |-           | Select a dataspace object                                        |
| field_2.workflow_id       | string  |-           | The name of the result folder generated by the FDE solver        |
| field_2.mode              | integer |-          |                                                                  |
| field_2.data              | object  | -          | Select a dataspace object                                        |
| optimize_position         | boolean | True      |                                                                  |
| x_shift                   | number  | 0         |                                                                  |
| y_shift                   | number  | 0         |                                                                  |
| z_shift                   | number  | 0         |                                                                  |
| recenter                  | string  | custom    | Selections are ['to_center_of_field_data_1', 'to_0_0', 'custom'] |
| shift_center              | integer | 1         |                                                                  |

**Example:**

```python
beam_res = simu[simu_name].run_fde_beam_and_extract(
                property={"define_gaussian_beam_by": "waist_size_and_position",  # [waist_size_and_position,beam_size_and_divergence],
                          "waist_radius": 5.2, "distance_from_waist": 1.5, "refractive_index": 1.45, "theta": 0, "phi": 0,
                          "polarization_angle": 90, "sample_span": 6, "sample_resolution": 200},
                savepath=plot_path + "beam_heatmap")
analysis.add(name="overlap", type="overlap",
        property={"field_1": {"workflow_id": beam_res.workflow_id, "mode": 0},
                "field_2": {"workflow_id": fde_res.workflow_id, "mode": 0},
                "optimize_position": True})
overlap_res = analysis["overlap"].run()
```

</div>

</font>